<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>MiR Cargo Nicaragua</title>

  <style>
    :root{
      --azulRoyal:#1f4fae;
      --azulNavy:#1b3a6b;
      --azulDeep:#0f2a55;

      --celesteTxt:#2ea8ff;
      --celesteBg:rgba(46,168,255,.14);

      --bg:#f6f7fb;
      --card:#ffffff;
      --border:rgba(15,23,42,.10);
      --text:#0f172a;
      --muted:#64748b;

      --accent:#ffd1a6;
      --accentH:#ffbf85;

      --wa:#25D366;
      --waH:#1ebe5d;

      --shadowSoft: 0 10px 26px rgba(2,6,23,.12);
      --radius:18px;
      --radius2:22px;
      --max:980px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 900px at 20% -10%, rgba(31,79,174,.24), transparent 55%),
                  radial-gradient(900px 700px at 110% 10%, rgba(255,209,166,.35), transparent 45%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{max-width:var(--max); margin:0 auto; padding:16px 14px 40px;}
    header{
      background: linear-gradient(135deg, rgba(27,58,107,.94), rgba(11,31,58,.96));
      border:1px solid rgba(255,255,255,.10);
      border-radius:var(--radius2);
      padding:16px;
      box-shadow: var(--shadowSoft);
      color:#fff;
      position:sticky;
      top:10px;
      z-index:5;
      backdrop-filter: blur(10px);
    }
    .brandRow{display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;}
    .brand{
      display:flex; gap:12px; align-items:center;
    }
    .logo{
      width:46px; height:46px; border-radius:14px;
      background: linear-gradient(135deg, rgba(46,168,255,.25), rgba(255,209,166,.22));
      border:1px solid rgba(255,255,255,.12);
      display:grid; place-items:center;
      box-shadow: 0 10px 22px rgba(0,0,0,.18);
      font-weight:900;
      letter-spacing:.5px;
    }
    .title h1{margin:0; font-size:18px; letter-spacing:.2px}
    .title p{margin:2px 0 0; font-size:12px; opacity:.85}

    .branches{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .branch{
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.14);
      border-radius:999px;
      padding:8px 10px;
      display:flex; gap:8px; align-items:center;
      font-size:12px;
      white-space:nowrap;
    }
    .branch b{font-size:12px}
    .branch .btn{
      text-decoration:none;
      background: rgba(255,209,166,.92);
      color:#1b2a3d;
      padding:7px 10px;
      border-radius:999px;
      font-weight:800;
      border:1px solid rgba(255,255,255,.16);
    }
    .branch .btn:hover{background: var(--accentH)}
    .branch .btn.wa{background: rgba(37,211,102,.92); color:#073018}
    .branch .btn.wa:hover{background: var(--waH)}

    .grid{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
    }
    @media (min-width: 860px){
      .grid{grid-template-columns: 1fr 1fr;}
    }

    .card{
      background: var(--card);
      border:1px solid var(--border);
      border-radius: var(--radius2);
      box-shadow: var(--shadowSoft);
      padding:14px;
      overflow:hidden;
    }
    .card h2{
      margin:0 0 10px;
      font-size:16px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .badge{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      background: rgba(46,168,255,.12);
      color: var(--azulRoyal);
      border: 1px solid rgba(46,168,255,.18);
      font-weight:800;
    }

    .searchRow{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      margin-bottom:10px;
    }
    input[type="text"]{
      flex:1;
      min-width: 180px;
      border-radius: 14px;
      padding: 12px 12px;
      border:1px solid rgba(15,23,42,.12);
      outline:none;
      font-size:14px;
      background: #fff;
    }
    input[type="text"]:focus{
      border-color: rgba(46,168,255,.55);
      box-shadow: 0 0 0 4px rgba(46,168,255,.14);
    }
    .btnMain{
      border:none;
      background: var(--accent);
      padding: 12px 14px;
      border-radius: 14px;
      font-weight:900;
      cursor:pointer;
      color:#1b2a3d;
      border:1px solid rgba(15,23,42,.06);
    }
    .btnMain:hover{background: var(--accentH)}
    .btnGhost{
      border:none;
      background: rgba(31,79,174,.10);
      padding: 12px 14px;
      border-radius: 14px;
      font-weight:900;
      cursor:pointer;
      color: var(--azulNavy);
      border:1px solid rgba(31,79,174,.12);
    }
    .btnGhost:hover{background: rgba(31,79,174,.14)}

    .hint{margin:0 0 10px; font-size:12px; color:var(--muted)}
    .empty{
      display:none;
      background: rgba(2,6,23,.03);
      border:1px dashed rgba(2,6,23,.20);
      border-radius: 16px;
      padding: 12px;
      color: var(--muted);
      font-size: 13px;
    }

    .result-block{
      border:1px solid rgba(15,23,42,.10);
      border-radius: 18px;
      padding: 12px;
      margin-top: 10px;
      background: linear-gradient(180deg, rgba(255,255,255,.98), rgba(246,247,251,.92));
    }
    .result-block p{margin:6px 0; font-size:13px}
    .status-pill{
      display:inline-block;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(37,211,102,.10);
      border: 1px solid rgba(37,211,102,.18);
      color:#0a5a2e;
      font-weight:900;
      font-size:12px;
    }
    .detail-actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .view-btn{
      border:none;
      background: rgba(31,79,174,.10);
      color: var(--azulNavy);
      border: 1px solid rgba(31,79,174,.16);
      border-radius: 14px;
      padding: 10px 12px;
      font-weight:900;
      cursor:pointer;
      font-size:13px;
    }
    .view-btn:hover{background: rgba(31,79,174,.14)}
    footer{
      margin-top: 16px;
      text-align:center;
      font-size:12px;
      color: var(--muted);
      opacity:.9;
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brandRow">
        <div class="brand">
          <div class="logo">MIR</div>
          <div class="title">
            <h1>MiR Cargo Nicaragua</h1>
            <p>Rastreo A√©reo y Mar√≠timo ‚Ä¢ Fotos y firma (si aplica)</p>
          </div>
        </div>

        <div class="branches">
          <div class="branch">
            <b>Miami</b>
            <a class="btn" href="tel:+13055555555">Llamar</a>
            <a class="btn wa" href="https://wa.me/13055555555" target="_blank" rel="noopener">WhatsApp</a>
          </div>
          <div class="branch">
            <b>Managua</b>
            <a class="btn" href="https://maps.app.goo.gl/adbe3fBPA6vcGd8t5" target="_blank" rel="noopener">Maps</a>
          </div>
          <div class="branch">
            <b>Chinandega</b>
            <a class="btn" href="https://maps.app.goo.gl/PVczh5oMTN3kp53R6" target="_blank" rel="noopener">Maps</a>
          </div>
        </div>
      </div>
    </header>

    <div class="grid">
      <!-- MARITIMO -->
      <div class="card">
        <h2>Mar√≠timo <span class="badge">Contenedor</span></h2>
        <p class="hint">Busc√° por tracking u orden (tambi√©n pod√©s escribir el nombre).</p>
        <div class="searchRow">
          <input id="searchMaritimo" type="text" placeholder="Ej: 123456, ORDEN-88, Juan..." />
          <button class="btnMain" onclick="searchTracking('Maritimo')">Buscar</button>
          <button class="btnGhost" onclick="resetUI('Maritimo')">Reset</button>
        </div>
        <div id="emptyMaritimo" class="empty">No se encontr√≥ nada. Revis√° el n√∫mero y prob√° de nuevo.</div>
        <div id="resultsMaritimo"></div>
      </div>

      <!-- AEREO -->
      <div class="card">
        <h2>A√©reo <span class="badge">Encomiendas</span></h2>
        <p class="hint">Busc√° por tracking u orden (tambi√©n pod√©s escribir el nombre).</p>
        <div class="searchRow">
          <input id="searchAereo" type="text" placeholder="Ej: 837025, ORDEN-22, Maria..." />
          <button class="btnMain" onclick="searchTracking('Aereo')">Buscar</button>
          <button class="btnGhost" onclick="resetUI('Aereo')">Reset</button>
        </div>
        <div id="emptyAereo" class="empty">No se encontr√≥ nada. Revis√° el n√∫mero y prob√° de nuevo.</div>
        <div id="resultsAereo"></div>
      </div>

      <!-- CORREO -->
      <div class="card">
        <h2>Correo <span class="badge">USPS/UPS/FedEx</span></h2>
        <p class="hint">Busc√° por tracking u orden (tambi√©n pod√©s escribir el nombre).</p>
        <div class="searchRow">
          <input id="searchCorreo" type="text" placeholder="Ej: 1Z..., 9400..., ORDEN-..." />
          <button class="btnMain" onclick="searchTracking('Correo')">Buscar</button>
          <button class="btnGhost" onclick="resetUI('Correo')">Reset</button>
        </div>
        <div id="emptyCorreo" class="empty">No se encontr√≥ nada. Revis√° el n√∫mero y prob√° de nuevo.</div>
        <div id="resultsCorreo"></div>
      </div>

      <!-- COMPRA -->
      <div class="card">
        <h2>Compras <span class="badge">Recibido</span></h2>
        <p class="hint">Busc√° por tracking/orden o nombre. (Muestra las √∫ltimas 40.)</p>
        <div class="searchRow">
          <input id="searchCompra" type="text" placeholder="Ej: ORDEN-100, Amazon, Pedro..." />
          <button class="btnMain" onclick="searchTracking('Compra')">Buscar</button>
          <button class="btnGhost" onclick="resetUI('Compra')">Reset</button>
        </div>
        <div id="emptyCompra" class="empty">No se encontr√≥ nada. Revis√° el n√∫mero y prob√° de nuevo.</div>
        <div id="resultsCompra"></div>
      </div>
    </div>

    <footer>
      ¬© MiR Cargo Nicaragua ‚Ä¢ Rastreo en vivo desde Google Sheets
    </footer>
  </div>

  <script>
    // ‚úÖ PEG√Å AQU√ç TUS LINKS CSV (uno o varios por tipo)
    // Ejemplo:
    // const urls = {
    //   Maritimo: ["https://docs.google.com/spreadsheets/d/e/.../pub?output=csv"],
    //   Aereo:    ["https://docs.google.com/spreadsheets/d/e/.../pub?output=csv"],
    //   Correo:   ["https://docs.google.com/spreadsheets/d/e/.../pub?output=csv"],
    //   Compra:   ["https://docs.google.com/spreadsheets/d/e/.../pub?output=csv"]
    // };
    const urls = {
      Maritimo: [],
      Aereo: [],
      Correo: [],
      Compra: []
    };

    // Helpers
    function safe(obj, keys){
      for(const k of keys){
        if(obj && obj[k] != null && String(obj[k]).trim() !== "") return String(obj[k]).trim();
      }
      return "";
    }

    function parseDate(s){
      if(!s) return new Date(0);
      const t = String(s).trim();

      // intenta ISO / Date.parse directo
      const d1 = new Date(t);
      if(!isNaN(d1.getTime())) return d1;

      // intenta dd/mm/yyyy o mm/dd/yyyy con horas
      const m = t.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})(?:\s+(\d{1,2}):(\d{2})(?::(\d{2}))?\s*(AM|PM)?)?$/i);
      if(m){
        let a = parseInt(m[1],10), b = parseInt(m[2],10), y = parseInt(m[3],10);
        if(y < 100) y += 2000;
        let hh = m[4] ? parseInt(m[4],10) : 0;
        const mm = m[5] ? parseInt(m[5],10) : 0;
        const ss = m[6] ? parseInt(m[6],10) : 0;
        const ap = (m[7]||"").toUpperCase();
        if(ap === "PM" && hh < 12) hh += 12;
        if(ap === "AM" && hh === 12) hh = 0;

        // heur√≠stica: si a>12 entonces es dd/mm, si b>12 entonces es mm/dd
        let day = a, mon = b;
        if(a <= 12 && b <= 12){
          // si ambos <=12 asumimos mm/dd
          mon = a; day = b;
        } else if(a > 12){
          day = a; mon = b;
        } else if(b > 12){
          mon = a; day = b;
        }
        return new Date(y, mon-1, day, hh, mm, ss);
      }
      return new Date(0);
    }

    function formatFechaBonita(s){
      const d = parseDate(s);
      if(isNaN(d.getTime()) || d.getTime() === 0) return (s || "");
      const opt = { year:'numeric', month:'long', day:'numeric', hour:'numeric', minute:'2-digit' };
      return d.toLocaleString('es-US', opt);
    }

    function normalizeImageUrl(u){
      if(!u) return "";
      let url = String(u).trim();
      // limpia comillas
      url = url.replace(/^['"]|['"]$/g,"");
      // si es "open?id=" etc, lo deja igual; solo evita espacios
      return url;
    }

    function resetUI(type){
      document.getElementById(`search${type}`).value = "";
      document.getElementById(`results${type}`).innerHTML = "";
      document.getElementById(`empty${type}`).style.display = "none";
    }

    function renderTable(list,type){
      const container = document.getElementById(`results${type}`);
      const empty = document.getElementById(`empty${type}`);
      container.innerHTML = "";
      empty.style.display = "none";
      if(!list.length){ empty.style.display="block"; return; }

      list.sort((a,b)=>parseDate(safe(b,["Fecha","FECHA"])) - parseDate(safe(a,["Fecha","FECHA"])));
      if(type === "Compra") list = list.slice(0,40);

      list.forEach(r=>{
        const fechaRaw = safe(r,["Fecha","FECHA"]);
        const fecha = formatFechaBonita(fechaRaw);

        const track = safe(r,["Tracking","Tracking #","Orden","ORDEN"]);
        const nombre = safe(r,["Nombre","Cliente","CLIENTE"]);
        const status = safe(r,["Status","STATUS"]);
        const agente = safe(r,["Agente","AGENTE","Usuario"]);
        const foto  = normalizeImageUrl(safe(r,["Web url","Web URL"]));
        const foto2 = normalizeImageUrl(safe(r,["Web url2","Web URL2"]));
        const foto3 = normalizeImageUrl(safe(r,["Web url3","Web URL3"]));
        const firma = normalizeImageUrl(safe(r,["Firma url","Firma URL"]));

        let html = `<div class="result-block">`;
        html += `<p><strong>Fecha:</strong> ${fecha}</p>`;
        html += `<p><strong>Tracking:</strong> ${track}</p>`;
        if(type === "Compra"){
          html += `<p><strong>Nombre:</strong> ${nombre}</p>`;
          html += `<p><strong>Agente:</strong> ${agente}</p>`;
        } else {
          html += `<p><strong>Status:</strong> <span class="status-pill">${status}</span></p>`;
          html += `<p><strong>Agente:</strong> ${agente}</p>`;
        }
        html += `<div class="detail-actions">`;
        if(foto)  html += `<button class="view-btn" type="button" onclick="window.open('${foto}','_blank')">üì∑ Ver foto</button>`;
        if(foto2) html += `<button class="view-btn" type="button" onclick="window.open('${foto2}','_blank')">üì∑ Ver foto 2</button>`;
        if(foto3) html += `<button class="view-btn" type="button" onclick="window.open('${foto3}','_blank')">üì∑ Ver foto 3</button>`;
        if(type !== "Compra" && firma) html += `<button class="view-btn" type="button" onclick="window.open('${firma}','_blank')">‚úçÔ∏è Ver firma</button>`;
        html += `</div></div>`;
        container.insertAdjacentHTML("beforeend", html);
      });
    }

    async function searchTracking(type){
      const input = document.getElementById(`search${type}`);
      const code = (input.value || "").trim().toLowerCase();
      if(!code) return;

      let data = [];
      const links = Array.isArray(urls[type]) ? urls[type] : [urls[type]];
      for(const link of links){
        await new Promise(resolve=>{
          Papa.parse(link + "&t=" + Date.now(),{
            download:true, header:true, skipEmptyLines:true,
            complete:res=>{ data = data.concat(res.data || []); resolve(); }
          });
        });
      }

      const filtered = data.filter(r=>{
        const track = safe(r,["Tracking","Tracking #","Orden","ORDEN"]).toLowerCase();
        const name  = safe(r,["Nombre","Cliente"]).toLowerCase();
        return track.includes(code) || name.includes(code);
      });

      renderTable(filtered, type);
    }

    ["Maritimo","Aereo","Correo","Compra"].forEach(type=>{
      const el = document.getElementById(`search${type}`);
      el.addEventListener("keydown", (e)=>{
        if(e.key === "Enter") searchTracking(type);
      });
    });
  </script>
</body>
</html>
